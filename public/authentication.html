<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication & Certificates - AEAT VERI*FACTU API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                }
            }
        }
    </script>
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 221.2 83.2% 53.3%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96%;
            --secondary-foreground: 222.2 84% 4.9%;
            --muted: 210 40% 96%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96%;
            --accent-foreground: 222.2 84% 4.9%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 221.2 83.2% 53.3%;
        }
        .dark {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 217.2 91.2% 59.8%;
            --primary-foreground: 222.2 84% 4.9%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 224.3 76.3% 94.1%;
        }
    </style>
</head>
<body class="h-full bg-background text-foreground">
    <div class="grid max-w-screen-2xl w-full mx-auto grid-rows-[min-content_1fr] grid-cols-1 lg:grid-cols-[280px_1fr]">
        <!-- Sidebar -->
        <aside class="hidden lg:block border-r bg-card">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
                        <span class="text-primary-foreground font-bold text-sm">AEAT</span>
                    </div>
                    <div>
                        <h1 class="font-semibold text-lg">VERI*FACTU API</h1>
                        <p class="text-sm text-muted-foreground">Documentation</p>
                    </div>
                </div>
                
                <nav class="space-y-1">
                    <div class="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3">Documentation</div>
                    <a href="index.html" class="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-accent hover:text-accent-foreground">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                        </svg>
                        Welcome
                    </a>
                    <a href="authentication.html" class="flex items-center gap-3 px-3 py-2 rounded-md bg-accent text-accent-foreground">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                        </svg>
                        Authentication
                    </a>
                    
                    <div class="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3 mt-6">API Reference</div>
                    <a href="alta-register-invoice.html" class="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-accent hover:text-accent-foreground">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Register Invoice
                    </a>
                    <a href="baja-cancel-invoice.html" class="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-accent hover:text-accent-foreground">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Cancel Invoice
                    </a>
                    <a href="consulta-query-invoice.html" class="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-accent hover:text-accent-foreground">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        Query Invoice
                    </a>
                    <a href="parameters-and-fields.html" class="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-accent hover:text-accent-foreground">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Parameters & Fields
                    </a>
                    <a href="error-handling.html" class="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-accent hover:text-accent-foreground">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        Error Handling
                    </a>
                    <a href="xsd-schema-reference.html" class="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-accent hover:text-accent-foreground">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                        </svg>
                        XSD Schema
                    </a>
                    
                    <div class="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3 mt-6">Getting Started</div>
                    <a href="authentication.html" class="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-accent hover:text-accent-foreground">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                        </svg>
                        Authentication Setup
                    </a>
                    <a href="node-implementation.html" class="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-accent hover:text-accent-foreground">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                        </svg>
                        Node.js Implementation
                    </a>
                    <a href="examples.html" class="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-accent hover:text-accent-foreground">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        Examples
                    </a>
                    <a href="quick-reference.html" class="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-accent hover:text-accent-foreground">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Quick Reference
                    </a>
                </nav>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="px-4 lg:px-8 py-8">
            <div class="prose dark:prose-invert prose-neutral max-w-none">
                <div class="text-sm font-semibold text-primary mb-2">Authentication & Certificates</div>
                <h1 class="group relative text-4xl font-extrabold flex gap-3.5 items-center mb-6">
                    STEP 1 & 3: Authentication & Certificates
                </h1>
                
                <div class="rounded-lg border bg-card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-4">Overview</h2>
                    <p class="text-muted-foreground mb-4">The AEAT VERI*FACTU webservice uses <strong>mutual TLS authentication</strong> (also known as client certificate authentication). This means both the client (your application) and the server (AEAT) authenticate each other using digital certificates.</p>
                    
                    <div class="grid gap-4 md:grid-cols-2">
                        <div class="space-y-2">
                            <h3 class="text-lg font-semibold">Key Requirements:</h3>
                            <ul class="space-y-1 text-sm">
                                <li class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span><strong>Protocol</strong>: HTTPS</span>
                                </li>
                                <li class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span><strong>Authentication</strong>: Qualified electronic certificate required</span>
                                </li>
                                <li class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span><strong>Encoding</strong>: UTF-8</span>
                                </li>
                                <li class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span><strong>SOAP Version</strong>: SOAP 1.1 Document/Literal style</span>
                                </li>
                                <li class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span><strong>Message Format</strong>: XML messages according to XSD schemas</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="grid gap-6 md:grid-cols-2 mb-8">
                    <div class="rounded-lg border bg-card p-6">
                        <h2 class="text-xl font-semibold mb-4">STEP 1: Prerequisites</h2>
                        <h3 class="text-lg font-semibold mb-3">What you need before starting:</h3>
                        <ul class="space-y-2 text-sm">
                            <li class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span><strong>FNMT Certificate</strong> (you already have one)</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span><strong>Your CRM system</strong> (running and accessible)</span>
                            </li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold mb-3 mt-6">Certificate Requirements:</h3>
                        <ul class="space-y-1 text-sm">
                            <li><strong>Format</strong>: X.509 certificate with private key</li>
                            <li><strong>Storage</strong>: Must be securely stored on your server</li>
                            <li><strong>Validity</strong>: Check expiration date (typically 2-3 years)</li>
                        </ul>
                        
                        <div class="mt-4 p-3 bg-blue-50 rounded-md">
                            <p class="text-sm text-blue-800">
                                → <a href="node-implementation.html" class="font-medium underline">Next: Go to Step 2 - Database Setup</a>
                            </p>
                        </div>
                    </div>
                    
                    <div class="rounded-lg border bg-card p-6">
                        <h2 class="text-xl font-semibold mb-4">STEP 3: Certificate Setup</h2>
                        <h3 class="text-lg font-semibold mb-3">Required Certificates</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-semibold text-sm mb-2">Client Certificate</h4>
                                <ul class="text-sm space-y-1">
                                    <li><strong>Purpose</strong>: Authenticates your application to AEAT</li>
                                    <li><strong>Format</strong>: X.509 certificate with private key</li>
                                    <li><strong>Storage</strong>: Must be securely stored on your server</li>
                                    <li><strong>Validity</strong>: Typically 2-3 years, must be renewed before expiration</li>
                                </ul>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-sm mb-2">Server Certificate</h4>
                                <ul class="text-sm space-y-1">
                                    <li><strong>Purpose</strong>: Verifies AEAT's identity</li>
                                    <li><strong>Format</strong>: X.509 certificate</li>
                                    <li><strong>Source</strong>: Provided by AEAT</li>
                                    <li><strong>Verification</strong>: Your application must verify this certificate</li>
                                </ul>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-sm mb-2">Certificate Authority (CA) Chain</h4>
                                <ul class="text-sm space-y-1">
                                    <li><strong>Purpose</strong>: Establishes trust between client and server</li>
                                    <li><strong>Components</strong>: Root CA + Intermediate CA certificates</li>
                                    <li><strong>Source</strong>: AEAT provides the complete chain</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="rounded-lg border bg-card p-6 mb-8">
                    <h2 class="text-xl font-semibold mb-4">Obtaining Certificates</h2>
                    <p class="text-muted-foreground mb-4">To obtain your client certificate, you must apply to the <a href="https://www.fnmt.gob.es/" target="_blank" class="text-primary hover:underline">FNMT (Fábrica Nacional de Moneda y Timbre)</a>. The process typically involves:</p>
                    
                    <ol class="list-decimal list-inside space-y-2 text-sm mb-4">
                        <li><strong>Application</strong>: Complete the online application form on the FNMT website.</li>
                        <li><strong>Verification</strong>: Verify your identity at a designated office (e.g., AEAT office, Social Security office).</li>
                        <li><strong>Download</strong>: Download and install your certificate.</li>
                    </ol>
                    
                    <p class="text-muted-foreground mb-4">For server certificates and CA chains, refer to the official AEAT documentation or contact AEAT directly.</p>
                    
                    <div class="grid gap-4 md:grid-cols-2">
                        <div class="p-4 bg-green-50 rounded-md">
                            <h4 class="font-semibold text-green-800 mb-2">Certificate Costs:</h4>
                            <ul class="text-sm text-green-700 space-y-1">
                                <li><strong>For Individuals (Persona Física)</strong>: FREE</li>
                                <li><strong>For Companies (Persona Jurídica)</strong>: €14-20</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="rounded-lg border bg-card p-6 mb-8">
                    <h2 class="text-xl font-semibold mb-4">Certificate Installation & Configuration</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Server-Side Storage:</h3>
                            <p class="text-muted-foreground mb-4">Your X.509 certificate (including the private key) must be securely stored on your server. Common formats include `.p12` or `.pem`.</p>
                            <p class="text-muted-foreground mb-4">Example (Node.js):</p>
                            <div class="bg-muted p-4 rounded-md">
                                <pre class="text-sm font-mono"><code>// This is where your certificate is stored
const certificate = {
  file: '/path/to/your/certificate.p12',
  password: 'your_password',
  environment: 'test' // or 'production'
};</code></pre>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Mutual TLS Setup:</h3>
                            <p class="text-muted-foreground mb-4">When making requests to the AEAT webservice, you must configure your HTTP client to use mutual TLS. This involves providing your client certificate and key, and optionally the CA certificate chain for server verification.</p>
                            <p class="text-muted-foreground mb-4">Example (Node.js with `https.Agent`):</p>
                            <div class="bg-muted p-4 rounded-md">
                                <pre class="text-sm font-mono"><code>const https = require('https');
const fs = require('fs');

const agent = new https.Agent({
  pfx: fs.readFileSync('/path/to/your/certificate.p12'),
  passphrase: 'your_password',
  // Optionally, for server certificate verification:
  // ca: [fs.readFileSync('/path/to/aeat_ca_chain.pem')]
});

// Use this agent with your HTTP client (e.g., axios)
const axios = require('axios');
axios.defaults.httpsAgent = agent;

// Now make your SOAP requests
async function sendSoapRequest(xmlPayload) {
  try {
    const response = await axios.post(
      'https://prewww1.aeat.es/wlpl/TIKE-CONT/ws/SistemaFacturacion/VerifactuSOAP',
      xmlPayload,
      {
        headers: {
          'Content-Type': 'text/xml;charset=UTF-8',
          'SOAPAction': '""' // Required for SOAP 1.1 Document/Literal
        }
      }
    );
    console.log(response.data);
  } catch (error) {
    console.error('SOAP Request Error:', error.message);
  }
}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="rounded-lg border bg-card p-6">
                    <h2 class="text-xl font-semibold mb-4">Simple CRM Integration</h2>
                    <p class="text-muted-foreground mb-4">Integrating the AEAT VERI*FACTU API into your CRM involves storing certificate details, updating your database schema to track invoice status, and implementing the logic to send and receive data from AEAT.</p>
                    
                    <div class="space-y-4">
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Database Adjustments:</h3>
                            <p class="text-muted-foreground mb-4">You'll need to add fields to your invoice table to store the AEAT's CSV code, status, and any error messages.</p>
                            <div class="bg-muted p-4 rounded-md">
                                <pre class="text-sm font-mono"><code>-- Add these columns to your invoices table
ALTER TABLE invoices ADD COLUMN aeat_csv_code VARCHAR(100);
ALTER TABLE invoices ADD COLUMN aeat_status VARCHAR(20);
ALTER TABLE invoices ADD COLUMN aeat_error TEXT;</code></pre>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Basic Workflow:</h3>
                            <p class="text-muted-foreground mb-4">When an invoice is saved in your CRM, you'll send it to AEAT, then update your database with the response.</p>
                            <div class="bg-muted p-4 rounded-md">
                                <pre class="text-sm font-mono"><code>// When you save an invoice
async function saveInvoice(invoice) {
  // 1. Save in your CRM
  const invoiceId = await saveToCRM(invoice);

  // 2. Send to AEAT
  const aeatResponse = await sendToAEAT(invoice);

  // 3. Save CSV code and status
  await updateInvoice(invoiceId, {
    aeat_csv_code: aeatResponse.csv,
    aeat_status: aeatResponse.status,
    aeat_error: aeatResponse.error
  });
}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</body>
</html>