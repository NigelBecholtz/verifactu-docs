# Parameters and Fields

## Overview

This document provides detailed explanations of all recurring parameters and fields used across the AEAT VERI*FACTU webservice operations. Understanding these parameters is crucial for successful integration.

## Core Parameters

### TiempoEsperaEnvio

**What it is**: Expected processing time in seconds for the operation.

**Purpose**: 
- Allows AEAT to optimize processing resources
- Helps with timeout configuration
- Provides processing time estimates

**Values**:
- **Minimum**: 30 seconds
- **Maximum**: 300 seconds (5 minutes)
- **Recommended**: 30-60 seconds for most operations
- **Large batches**: 120-300 seconds

**When to use**:
- **Simple operations**: 30 seconds
- **Complex invoices**: 60 seconds
- **Batch operations**: 120+ seconds
- **Peak hours**: Increase by 50%

**Example**:
```xml
<verifactu:TiempoEsperaEnvio>60</verifactu:TiempoEsperaEnvio>
```

### EstadoEnvio

**What it is**: Overall status of the operation.

**Purpose**:
- Indicates success or failure of the operation
- Provides high-level status information
- Determines next steps in processing

**Possible Values**:

| Value | Description | Meaning | Action Required |
|-------|-------------|---------|-----------------|
| **Correcto** | Successful | Operation completed successfully | None - process normally |
| **Rechazado** | Rejected | Operation was rejected | Check errors, correct data |
| **AceptadoConErrores** | Accepted with errors | Operation accepted but with warnings | Review warnings, may need correction |
| **Pendiente** | Pending | Operation is pending processing | Wait for completion |
| **Procesando** | Processing | Operation is being processed | Wait for completion |

**Usage Examples**:
```xml
<verifactu:EstadoEnvio>Correcto</verifactu:EstadoEnvio>
```

### RespuestaLinea

**What it is**: Per-invoice response details.

**Purpose**:
- Provides detailed status for each invoice
- Contains invoice-specific information
- Includes errors and warnings per invoice

**Structure**:
```xml
<verifactu:RespuestaLinea>
  <verifactu:EstadoRegistro>Correcto</verifactu:EstadoRegistro>
  <verifactu:CSV>ABC123DEF456</verifactu:CSV>
  <verifactu:NumFactura>INV-2024-001</verifactu:NumFactura>
  <verifactu:FechaFactura>2024-01-15</verifactu:FechaFactura>
  <verifactu:ImporteTotal>1000.00</verifactu:ImporteTotal>
  <verifactu:Errores>
    <!-- Error details if any -->
  </verifactu:Errores>
</verifactu:RespuestaLinea>
```

**Fields per RespuestaLinea**:

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `EstadoRegistro` | Enum | Registration status | "Correcto" |
| `CSV` | String | Secure verification code | "ABC123DEF456" |
| `NumFactura` | String | Invoice number | "INV-2024-001" |
| `FechaFactura` | Date | Invoice date | "2024-01-15" |
| `ImporteTotal` | Decimal | Total amount | 1000.00 |
| `Errores` | Array | Error details | See error structure |

### CSV (Código Seguro de Verificación)

**What it is**: Secure verification code generated by AEAT.

**Purpose**:
- Proves invoice authenticity
- Enables customer verification
- Provides audit trail
- Prevents fraud

**Characteristics**:
- **Length**: 12 characters
- **Format**: Alphanumeric (A-Z, 0-9)
- **Uniqueness**: Unique per invoice
- **Validity**: Permanent (does not expire)
- **Generation**: Generated by AEAT only

**Example**:
```
CSV: ABC123DEF456
```

**Usage**:
- **Customer Verification**: Customers can verify invoices
- **Audit Trail**: Proof of registration with AEAT
- **Compliance**: Required for tax compliance
- **Storage**: Must be stored securely

**Storage Requirements**:
- **Local Storage**: Store CSV for each invoice
- **Backup**: Include in backup procedures
- **Access Control**: Limit access to authorized personnel
- **Retention**: Keep for legal retention period

### TipoOperacion

**What it is**: Type of operation being performed.

**Purpose**:
- Identifies the type of operation
- Determines processing rules
- Affects validation requirements

**Possible Values**:

| Value | Description | Use Case |
|-------|-------------|----------|
| **Alta** | Registration | Register new invoice |
| **Baja** | Cancellation | Cancel existing invoice |
| **Modificacion** | Modification | Modify existing invoice |
| **Consulta** | Query | Query invoice information |

**Example**:
```xml
<verifactu:TipoOperacion>Alta</verifactu:TipoOperacion>
```

### TipoComunicacion

**What it is**: Type of communication with AEAT.

**Purpose**:
- Identifies the communication type
- Determines processing requirements
- Affects response format

**Possible Values**:

| Value | Description | Use Case |
|-------|-------------|----------|
| **Alta** | Registration | Register invoice |
| **Baja** | Cancellation | Cancel invoice |
| **Consulta** | Query | Query invoice |
| **Modificacion** | Modification | Modify invoice |

**Example**:
```xml
<verifactu:TipoComunicacion>Alta</verifactu:TipoComunicacion>
```

## Data Types and Formats

### Date Formats

**Date (YYYY-MM-DD)**:
- **Format**: YYYY-MM-DD
- **Example**: "2024-01-15"
- **Validation**: Must be valid date
- **Range**: 1900-01-01 to 2099-12-31

**DateTime (YYYY-MM-DDTHH:MM:SS)**:
- **Format**: YYYY-MM-DDTHH:MM:SS
- **Example**: "2024-01-15T10:30:00"
- **Timezone**: UTC recommended
- **Validation**: Must be valid datetime

**Examples**:
```xml
<verifactu:FechaFactura>2024-01-15</verifactu:FechaFactura>
<verifactu:FechaEnvio>2024-01-15T10:30:00</verifactu:FechaEnvio>
```

### Amount Formats

**Decimal Precision**:
- **Precision**: 2 decimal places
- **Format**: 999999.99
- **Example**: 1000.00
- **Validation**: Must be positive

**Currency**:
- **Currency**: EUR (implicit)
- **Format**: Decimal with 2 decimal places
- **Range**: 0.01 to 999999.99

**Examples**:
```xml
<verifactu:ImporteTotal>1000.00</verifactu:ImporteTotal>
<verifactu:BaseImponible>826.45</verifactu:BaseImponible>
<verifactu:CuotaImpuesto>173.55</verifactu:CuotaImpuesto>
```

### NIF Formats

**Individual NIF (8 digits + 1 letter)**:
- **Format**: 12345678Z
- **Validation**: Must pass NIF check digit algorithm
- **Example**: "12345678Z"

**Company NIF (1 letter + 7 digits + 1 letter)**:
- **Format**: A12345674
- **Validation**: Must pass NIF check digit algorithm
- **Example**: "A12345674"

**Validation Rules**:
- **Length**: 9 characters
- **Format**: Must match pattern
- **Check Digit**: Must be valid
- **Characters**: Only letters and digits

**Examples**:
```xml
<verifactu:NIFEmisor>12345678Z</verifactu:NIFEmisor>
<verifactu:NIFReceptor>87654321A</verifactu:NIFReceptor>
```

### Invoice Number Formats

**Length**: 1-60 characters
**Characters**: Alphanumeric and common symbols
**Uniqueness**: Must be unique per issuer
**Format**: Free text (recommended: alphanumeric with separators)

**Examples**:
```xml
<verifactu:NumFactura>INV-2024-001</verifactu:NumFactura>
<verifactu:NumFactura>F2024001</verifactu:NumFactura>
<verifactu:NumFactura>INVOICE-001</verifactu:NumFactura>
```

## Validation Rules

### Required Field Validation

**Mandatory Fields**:
- All fields marked as required must be present
- Empty strings are not allowed for required fields
- Null values are not allowed for required fields

**Validation Examples**:
```xml
<!-- Valid -->
<verifactu:NIFEmisor>12345678Z</verifactu:NIFEmisor>

<!-- Invalid - empty -->
<verifactu:NIFEmisor></verifactu:NIFEmisor>

<!-- Invalid - missing -->
<!-- Field not present -->
```

### Format Validation

**Date Validation**:
- Must be valid date
- Must be in correct format
- Must be within valid range

**Amount Validation**:
- Must be positive
- Must have correct precision
- Must be within valid range

**NIF Validation**:
- Must be valid format
- Must pass check digit validation
- Must be registered with AEAT

### Business Rule Validation

**Invoice Number Uniqueness**:
- Must be unique per issuer
- Cannot be reused
- Must follow naming conventions

**Date Consistency**:
- Invoice date cannot be in the future
- Registration date must be after invoice date
- Cancellation date must be after registration date

**Amount Consistency**:
- Line totals must equal invoice total
- Tax calculations must be correct
- Discounts must be properly applied

## Error Handling

### Error Structure

**Error Response Format**:
```xml
<verifactu:Errores>
  <verifactu:Error>
    <verifactu:Codigo>001</verifactu:Codigo>
    <verifactu:Descripcion>Invalid NIF format</verifactu:Descripcion>
    <verifactu:Campo>NIFEmisor</verifactu:Campo>
    <verifactu:Valor>12345678</verifactu:Valor>
  </verifactu:Error>
</verifactu:Errores>
```

**Error Fields**:

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `Codigo` | String | Error code | "001" |
| `Descripcion` | String | Error description | "Invalid NIF format" |
| `Campo` | String | Field that caused error | "NIFEmisor" |
| `Valor` | String | Value that caused error | "12345678" |

### Common Error Codes

**Validation Errors (001-099)**:
- **001**: Invalid NIF format
- **002**: Missing required field
- **003**: Invalid date format
- **004**: Invalid amount format
- **005**: Invalid invoice number format

**Business Logic Errors (100-199)**:
- **101**: Duplicate invoice number
- **102**: Invalid tax calculation
- **103**: Missing tax information
- **104**: Invalid invoice type

**System Errors (200-299)**:
- **201**: Service unavailable
- **202**: Timeout error
- **203**: Certificate error
- **204**: Network error

## Best Practices

### Data Preparation

**Before Sending**:
- Validate all data locally
- Check NIF validity
- Verify amount calculations
- Ensure date consistency
- Check required fields

**Data Quality**:
- Use consistent formats
- Avoid special characters
- Ensure proper encoding
- Validate business rules

### Error Handling

**Error Processing**:
- Parse error responses
- Log all errors
- Implement retry logic
- Handle partial success
- Monitor error rates

**Recovery Strategies**:
- Correct data errors
- Retry transient errors
- Escalate system errors
- Maintain audit trail

### Performance Optimization

**Efficient Processing**:
- Use appropriate timeouts
- Batch operations when possible
- Cache frequently used data
- Monitor performance metrics

**Resource Management**:
- Reuse connections
- Implement connection pooling
- Monitor memory usage
- Handle large datasets

## Integration Considerations

### System Integration

**ERP Integration**:
- Map ERP fields to VERI*FACTU fields
- Handle data transformations
- Implement error handling
- Maintain data consistency

**Database Integration**:
- Store responses locally
- Maintain audit trail
- Implement data retention
- Handle data synchronization

### Monitoring and Logging

**Logging Requirements**:
- Log all requests and responses
- Include timestamps
- Record error details
- Maintain audit trail

**Monitoring**:
- Track success rates
- Monitor performance
- Alert on errors
- Generate reports

### Security Considerations

**Data Protection**:
- Encrypt sensitive data
- Secure storage
- Access control
- Audit logging

**Compliance**:
- Follow data retention rules
- Maintain audit trail
- Ensure data integrity
- Handle data securely
